((function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n=Array.prototype.indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1};g=function(a){var b,c,d,e,f,g;g=[];for(b in a){d=a[b],c={key:b};if(_.isRegExp(d))c.type="$regex",c.value=d;else if(_(d).isObject())for(e in d)f=d[e],m(e,f)&&(c.type=e,c.value=f);else c.type="$equal",c.value=d;g.push(c)}return g},m=function(a,b){switch(a){case"$in":case"$nin":case"$all":case"$any":return _(b).isArray();case"$size":return _(b).isNumber();case"$regex":return _(b).isRegExp();case"$like":case"$likeI":return _(b).isString();case"$between":return _(b).isArray()&&b.length===2;case"$cb":return _(b).isFunction();default:return!0}},l=function(a,b){switch(a){case"$like":case"$likeI":case"$regex":return _(b).isString();case"$contains":case"$all":case"$any":return _(b).isArray();case"$size":return _(b).isArray()||_(b).isString();case"$in":case"$nin":return b!=null;default:return!0}},h=function(a,b,c,d){switch(a){case"$equal":return c===b;case"$contains":return n.call(c,b)>=0;case"$ne":return c!==b;case"$lt":return c<b;case"$gt":return c>b;case"$lte":return c<=b;case"$gte":return c>=b;case"$between":return b[0]<c&&c<b[1];case"$in":return n.call(b,c)>=0;case"$nin":return n.call(b,c)<0;case"$all":return _(c).all(function(a){return n.call(b,a)>=0});case"$any":return _(c).any(function(a){return n.call(b,a)>=0});case"$size":return c.length===b;case"$exists":case"$has":return c!=null===b;case"$like":return c.indexOf(b)!==-1;case"$likeI":return c.toLowerCase().indexOf(b.toLowerCase())!==-1;case"$regex":return b.test(c);case"$cb":return b.call(d,c);default:return!1}},e=function(a,b,c,d){var e;return e=g(b),d(a,function(a){var b,d,f,g,i;for(g=0,i=e.length;g<i;g++){d=e[g],b=a.get(d.key),f=l(d.type,b),f&&(f=h(d.type,d.value,b,a));if(c===f)return c}return!c})},a=function(a,b){var c,d,e,f,g;g=[];for(c=e=0,f=a.length;e<f;c=++e)d=a[c],b(d)&&g.push(d);return g},j=function(a,b){var c,d,e,f,g;g=[];for(c=e=0,f=a.length;e<f;c=++e)d=a[c],b(d)||g.push(d);return g},i={$and:function(b,c){return e(b,c,!1,a)},$or:function(b,c){return e(b,c,!0,a)},$nor:function(a,b){return e(a,b,!0,j)},$not:function(a,b){return e(a,b,!1,j)}},b=function(a,b,c){var e,f,g,h;return g=JSON.stringify(b),e=(h=a._query_cache)!=null?h:a._query_cache={},f=e[g],f||(f=d(a,b,c),e[g]=f),f},c=function(a,b){var c,d,e;return c=_.intersection(["$and","$not","$or","$nor"],_(b).keys()),d=a.models,c.length===0?i.$and(d,b):(e=function(a,c){return i[c](a,b[c])},_.reduce(c,e,d))},d=function(a,b,d){var e;return e=c(a,b),d.sortBy&&(e=k(e,d)),e},k=function(a,b){return _(b.sortBy).isString()?a=_(a).sortBy(function(a){return a.get(b.sortBy)}):_(b.sortBy).isFunction()&&(a=_(a).sortBy(b.sortBy)),b.order==="desc"&&(a=a.reverse()),a},f=function(a,b){var c,d,e,f;return b.offset?e=b.offset:b.page?e=(b.page-1)*b.limit:e=0,c=e+b.limit,d=a.slice(e,c),b.pager&&_.isFunction(b.pager)&&(f=Math.ceil(a.length/b.limit),b.pager(f,d)),d};if(typeof require!="undefined"){if(typeof _=="undefined"||_===null)_=require("underscore");if(typeof Backbone=="undefined"||Backbone===null)Backbone=require("backbone")}Backbone.QueryCollection=Backbone.Collection.extend({query:function(a,c){var e;return c==null&&(c={}),c.cache?e=b(this,a,c):e=d(this,a,c),c.limit&&(e=f(e,c)),e},where:function(a,b){return b==null&&(b={}),new this.constructor(this.query(a,b))},reset_query_cache:function(){return this._query_cache={}}}),typeof exports!="undefined"&&(exports.QueryCollection=Backbone.QueryCollection)})).call(this)